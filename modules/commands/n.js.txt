let urls = require("./../../lekhanh/datajson/vdgai.json");
const axios = require("axios");
const fs = require("fs");

class Command {
    constructor(config) {
    this.config = config;
    this.queues = [];
    };
    async onLoad(o) {
    let status = false;
    if (!global.client.xx) global.client.xx = setInterval(_=> {
if (status == true || this.queues.length > 5) return;// mÃ y cÃ³ thá»ƒ chá»‰nh á»Ÿ Ä‘Ã¢y, náº¿u vd kháº£ dá»¥ng cÃ²n dÆ°á»›i 20 nÃ³ sáº½ get thÃªm vÃ  upload lÃªn fb
    status = true;
Promise.all([...Array(10)].map(e=>upload(urls[Math.floor(Math.random()*urls.length)]))).then(res=> { console.log(res, ...res); (this.queues.push(...res), status = false) });
},1000*5);// ...Array(10) (mÃ y thay sá»‘ á»Ÿ Ä‘Ã¢y lÃ  sá»‘ láº§n upload, tá»‘i thiá»ƒu lÃ  5,8,10,20,...)
async function streamURL(url, type) {
    return axios.get(url, {
      responseType: 'arraybuffer'
    }).then(res => {
      const path = __dirname + `/cache/${Date.now()}.${type}`;
      fs.writeFileSync(path, res.data);
      setTimeout(p => fs.unlinkSync(p), 1000 * 60, path);
      return fs.createReadStream(path);
    });
  }
async function upload(url) {
return o.api.httpPostFormData('https://upload.facebook.com/ajax/mercury/upload.php',{upload_1024: await streamURL(url, 'mp4')}).then(res => Object.entries(JSON.parse(res.replace('for (;;);', '')).payload?.metadata?.[0] || {})[0] );
        };};
  async run(o) {
      const allicon = ["ğŸ’","ğŸ’–","ğŸ’—","ğŸŒ¸","ğŸ’","ğŸ€","ğŸŒ¹","ğŸ","ğŸŒŸ","ğŸ","ğŸ’­","ğŸ’¦","ğŸ’¢","ğŸ’","ğŸ’©","âœ…","ğŸ’¤","â˜•","ğŸ¸","ğŸŸ","ğŸ§"];
      const icon = allicon[Math.floor(Math.random()*allicon.length)];
      const response = await axios.get('https://raw.githubusercontent.com/tuannr10/lekhanh/refs/heads/main/Data_Vtuan/datajson/thinh.json');
      const data = response.data;
      const thinhArray = Object.values(data.data);
      const randomThinh = thinhArray[Math.floor(Math.random() * thinhArray.length)];
      const send = msg => new Promise(r => o.api.sendMessage(msg, o.event.threadID, (err, res) => r(res || err), o.event.messageID));
      const t = process.uptime();
      const h = Math.floor(t / (60 * 60));
      const p = Math.floor((t % (60 * 60)) / 60);
      const s = Math.floor(t % 60);
      const userID = o.event.senderID;
      let userName = await new Promise(resolve => {
      o.api.getUserInfo(userID, (err, res) => {
      if (err) return resolve("NgÆ°á»i dÃ¹ng khÃ´ng xÃ¡c Ä‘á»‹nh");
      resolve(res[userID].name);});});
      let timeStart = Date.now();
    console.log(this.queues)
      send({body: `ğŸ‘‹ Hello ${userName} ${icon}\nâš ï¸ Báº¡n chÆ°a Nháº­p TÃªn Lá»‡nh.\nğŸ’« Thá»i gian hoáº¡t Ä‘á»™ng: ${h}:${p}:${s}\nğŸ’¤ ThÃ­nh: ${randomThinh}\nğŸ’¨ Tá»‘c Ä‘á»™ xá»­ lÃ½: ${Math.floor((Date.now() - timeStart)/1000)} giÃ¢y`,
          attachment: this.queues.splice(0, 1)});
  }
}
module.exports = new Command({
  name: "",
  version: "0.0.1",
  hasPermssion: 0,
  credits: "DC-Nam",
  description: "",
  commandCategory: "Tiá»‡n Ã­ch",
  usages: "[]",
  cooldowns: 8,
});